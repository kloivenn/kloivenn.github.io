<head>
	<link rel="stylesheet" type="text/css" href="src/linked-charts.css">
	<link rel="stylesheet" type="text/css" href="src/style.css">
	<script type="text/javascript" src = "src/linked-charts.min.js"></script>
	<script type="text/javascript" src = "src/data.js"></script>
	<title>Ex2plorer</title>
</head>
<body>
	<div style="border-bottom: 1px solid #CCC;">
		<div id = "topbar">
			<img src = "src/Mammalian_evolutionTransparent.png" width = "150px" style = "margin-left: 10px;">
			<div><span style="font-style: italic; color: #B2303A">Ex<sup>2</sup></span>plorer</div>
		</div>
	</div>
	<div id = "plots" style="display: grid; grid-template-columns: 550px 300px 300px">
		<div id = "tissues" style="text-align: center; grid-column: 1; grid-row: 1;"></div>
		<div id = "mainPlot" style="grid-column: 1; grid-row: 2/4;"></div>
		<div id = "geneTitle" style="grid-column: 2/4; grid-row: 1"><p style="font-weight: bold; font-size: 16pt;"></p></div>
		<div id = "transcription" style="grid-column: 2; grid-row: 2;"></div>
		<div id = "translation" style="grid-column: 3; grid-row: 2;"></div>
		<div id = "genes" style="grid-column: 2/4; grid-row: 3">
			<p id = "notFound" style="color: red; visibility: hidden; text-align: center;">Gene with this ID was not found.</p>
			<span>Enter gene name:</span> <input id = "geneName" type = "text" onchange = "searchGene(this.value);"> <br>
			<span>Enter Ensembl ID:</span> <input id = "ensembl" type = "text" onchange = "searchEnsembl(this.value);">
			<table id = "info"></table>
			<p id = "description"></p>
			Search for this gene on <a target="_blank" rel="noopener noreferrer">GeneCards</a>.
		</div>
	</div>
	<script type="text/javascript">
		var tissues = ["Brain", "Liver", "Testis"],
			colours = {Brain: "#3399CC", Liver: "#339900", Testis: "#FF6600"},
			tissue = "Brain",
			species = ["Human", "Macaque", "Mouse", "Opossum", "Platypus", "Chicken"],
			sp;

		function changeGene() {
			var geneId = Object.keys(data[tissue])[gene];
			d3.select("#geneTitle")
				.select("p")
					.style("color", data[tissue][geneId].padj < 0.1 ? (data[tissue][geneId].delta < 0 ? "#A6AE00" : "#9F00FF") : colours[tissue])
					.text(geneInfo.geneName[gene]);
			tr.update();
			tl.update();
			updateTable();
			d3.select("#geneName").node().value = geneInfo.geneName[gene];
			d3.select("#ensembl").node().value = geneInfo["geneId_" + (sp || "Human")][gene];
		}

		function updateTable() {
			d3.select("#info")
				.selectAll(".cell")
					.text(d => geneInfo[d[1] + "_" + d[0]][gene]);
			d3.select("#genes")
				.select("a")
					.attr("href", "https://www.genecards.org/cgi-bin/carddisp.pl?gene=" + geneInfo.geneName[gene]);
			d3.select("#genes")
				.select("#description")
					.html("<b>Description:</b> " + geneInfo.description[gene]);
		}

		function searchEnsembl(name) {
			d3.select("#notFound")
				.style("visibility", "hidden");			

			sp = undefined;
			if(name.substring(0, 4) == "ENSG")
				sp = "Human";
			if(name.substring(0, 7) == "ENSMUSG")
				sp = "Mouse";
			if(name.substring(0, 7) == "ENSMMUG")
				sp = "Macaque";
			if(name.substring(0, 7) == "ENSMODG")
				sp = "Opossum";
			if(name.substring(0, 7) == "ENSOANG")
				sp = "Platypus";
			if(name.substring(0, 7) == "ENSGALG")
				sp = "Chicken";


			if(!sp){
				d3.select("#notFound")
					.style("visibility", "visible")
				return;
			}

			var newGene = geneInfo["geneId_" + sp].indexOf(name);
			if(newGene == -1) 
				d3.select("#notFound")
					.style("visibility", "visible")
			else {
				gene = newGene;
				changeGene();
			}
		}

		function searchGene(name) {
			d3.select("#notFound")
				.style("visibility", "hidden");			

			var newGene = geneInfo.geneName.indexOf(name.toUpperCase());

			if(newGene == -1)
				d3.select("#notFound")
					.style("visibility", "visible")
			else {
				gene = newGene;
				changeGene();
			}
		}		

		d3.select("#tissues")
			.selectAll(".icon")
				.data(tissues)
				.enter()
					.append("img")
					.attr("width", 75)
					.attr("src", d => "src/" + d + ".svg")
					.attr("title", d => d)
					.attr("class", d => d == tissue ? "icon active" : "icon")
					.on("click", function(d) {
						tissue = d;
						d3.select("#tissues")
							.selectAll(".icon")
								.classed("active", false);
						d3.select(this).classed("active", true);
						mainPlot.update();
						tr.update();
						tl.update();
					});

		data = lc.separateBy(data, ["tissue", "geneId"]);
		var gene = 0;

		var mainPlot = lc.scatter()
			.elementIds(Object.keys(data[tissue]))
			.x(d => data[tissue][d].med)
			.y(d => data[tissue][d].delta)
			.domainY([-3, 3])
			.domainX([0, 10])
			.colour(d => data[tissue][d].padj < 0.1 ? (data[tissue][d].delta < 0 ? "#A6AE00" : "#9F00FF") : "white")
			.opacity(d => data[tissue][d].padj < 0.1 ? 0.8 : 0.4)
			.stroke(function() {return colours[tissue]})
			.strokeWidth(d => data[tissue][d].padj < 0.1 ? 1 : 2)
			.size(d => data[tissue][d].padj < 0.1 ? 2 : 1)
			.on_click(function(d) {
				gene = fpkm.geneId.indexOf(d);
				changeGene();
			})
			.place("#mainPlot");

//transcription
		var tr = lc.xLine("grid")
			.width(300)
			.height(300)
			.set_paddings({left: 65, right: 5})
			.domainY(species)
			.title("Transcriptional layer")
			.ticksRotateX(45)
			.elementIds(species)
			.lineFun((x, d) => d)
			.dasharray(1.5)
			.lineWidth(0.5)
			.colour(function() {return colours[tissue]});

		lc.pointLine("range", tr)
			.elementIds(species)
			.nsteps(2)
			.lineWidth(2.5)
			.y((i, d) => d)
			.x((i, d) => fpkm[d + "_" + tissue + "_TR_" + (i == 0 ? "min" : "max")][gene])
			.colour(function() {return colours[tissue]});

		lc.scatter("points", tr)
			.elementIds(species)
			.x(d => fpkm[d + "_" + tissue + "_TR_med"][gene])
			.y(d => d)
			.colour("white")
			.stroke(function() {return colours[tissue]})
			.place("#transcription");

//translation
		var tl = lc.xLine("grid")
			.width(300)
			.height(300)
			.set_paddings({left: 65})
			.domainY(species)
			.title("Translational layer")
			.ticksRotateX(45)
			.elementIds(species)
			.lineFun((x, d) => d)
			.dasharray(1.5)
			.lineWidth(0.5)
			.colour(function() {return colours[tissue]});

		lc.pointLine("range", tl)
			.elementIds(species)
			.nsteps(2)
			.lineWidth(2.5)
			.y((i, d) => d)
			.x((i, d) => fpkm[d + "_" + tissue + "_RP_" + (i == 0 ? "min" : "max")][gene])
			.colour(function() {return colours[tissue]});

		lc.scatter("points", tl)
			.elementIds(species)
			.x(d => fpkm[d + "_" + tissue + "_RP_med"][gene])
			.y(d => d)
			.colour(function() {return colours[tissue]})
			.stroke(function() {return colours[tissue]})
			.place("#translation");

		d3.select("#info")
			.selectAll(".tr")
				.data(["names"].concat(species))
				.enter()
					.append("tr");
		d3.select("#info")
			.selectAll("tr").selectAll("td")
				.data(d => ["names", "geneId", "chr"].map(el => [d, el]))
				.enter()
					.append("td")
					.html(function(d) {
						if(d[0] == "names" && d[1] == "names") return "";
						if(d[0] == "names")
							return d[1] == "geneId" ? "<b>Ensembl ID</b>" : "<b>Chromosome</b>";
						if(d[1] == "names")
							return "<i>" + d[0] + "</i>";
					})
					.attr("class", d => d[0] == "names" || d[1] == "names" ? "header" : "cell");

		changeGene();
	</script>
</body>