<html><head>
<title></title>
<script src="../src/linked-charts.min.js"></script>
<link rel="stylesheet" type="text/css" href="../src/linked-charts.css">
<link rel="stylesheet" type="text/css" href="../src/default.css">
<link rel="stylesheet" href="../src/prism.css">
<script src="../src/prism.js"></script>
</head>

<body>
<script src="../src/navTop.js"></script>
<div class="contentContainer">
	<div class="description">
<h1>Heatmap with two colour channels</h1>
<p>Generally, when a heatmap is generated, each cell corresponds to a single numeric value which in turn 
unambiguously defines colour of this cell via some colour scale. Yet, nothing in the <a href="../pages/api.html#heatmap"><code>heatmap</code></a> chart implemented 
in the <i>linked-charts</i> library requires the variables passed through the <a href="../pages/api.html#heatmap_value"><code>value</code></a> property to be just 
single numeric values. Of course, the default way of defining colour scale expects these value to be single numbers,
but a user can easily override this by setting the <a href="../pages/api.html#heatmap_colour"><code>colour</code></a> property. The function, user puts here, gets the value 
exactly how it has been passed to <a href="../pages/api.html#heatmap_value"><code>value</code></a> property. It can be anything: an array, a sting, another function - 
everything will do as soon as the user can define a way of transforming it into colour.</p>
<p>Here, we give an example how to utilise values that are not single numbers. The data that we are using here as an 
example contain the results of two assays, where 50 drugs in 5 different concentrations each were tested against 21 pancreatic cancer 
cell lines. RealTime-Glo (RTG) measures cell viability and is proportional to the 
number of methabolically active cells in a well. CellTox (CTX) gives us a value that is 
proportional to the amount of dead cells in a well. For each drug combination and concentration both values have been measured.</p>
<p>If a drug is active only in one of the assays, it means that either it doesn&apos;t really kill cells and they can recover afterwards, or
it kills them not fast enough, leaving plenty of alive and active cells unharmed. Therefore it can be useful to look at both assays
simultaniously. To this end we decided to use a well known in microscopy trick. We use a green channel for one assay and red for the other. Thus, the drugs, which in both assays demonstrated high effect will be shown in yellow, 
non-effective drugs will be shown as black cells and all others will be either red or green.</p>
<p>Therefore, this heatmap has two values per cell, each corresponds to a separate colour channel. For both channels we create an interactive
<a href="../pages/api.html#colourSlider"><code>colourSlider</code></a>. We also demonstrate, how one can select and manipulate multiple cells, and how to
select and update several layers at ones. The chart to the rigth shows the inhibition values for each indifidual concentration of all the
selected drug.</p>
</div>
	<script class="input" src="../src/data/inputdata.js"></script>
	<div class="layout"><table><tbody><tr>  <td id="heatmap" valign="top"></td>  <td id="scatterplot" valign="top"></td></tr></tbody></table></div>
	<script class="code">inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);
var drugs = Object.keys(inputData.RTG),
  cellLines = Object.keys(inputData.RTG[drugs[0]]);
var get_curve = function( screen, drug, cellLine, x ){
  var max = inputData[screen][drug][cellLine].max,
    min = inputData[screen][drug][cellLine].min,
    IC50 = inputData[screen][drug][cellLine].IC50,
    slope = inputData[screen][drug][cellLine].Slope,
    minConc = inputData[screen][drug][cellLine].minConc;
  return min + ( max - min )/ 
    (1 + Math.pow( 10, - ( x - Math.log10( IC50/minConc ) ) * slope));
}
var heatmap = lc.heatmap()
  .rowIds( drugs )
  .colIds( cellLines )
  .title( "Drug effect on viability and cytotoxicity" )
  .showLegend( false )
  .margins( {top: 100, left: 100, right: 10, bottom: 10} )
  .value( function( rowId, colId ) {  
    return [inputData.RTG[rowId][colId].avInh, 
            inputData.CTX[rowId][colId].avInh];
   })
  .informText( function( rowId, colId ) {
      return "Row: <b>" + rowId + "</b>;<br>" + 
            "Col: <b>" + colId + "</b>;<br>" + 
            "RTG = " + heatmap.get_value( rowId, colId )[0].toFixed( 2 ) + 
            " ; CTX = " + heatmap.get_value( rowId, colId )[1].toFixed( 2 );
      })
  .on_click( function( rowId, colId ) {
    heatmap.mark( d3.select( this ) );
  })
  .markedUpdated( function(){
    var ids = [],
      data = heatmap.get_marked();
    for(var i = 0; i < data.length; i++) {
      ids.push( data[i][0] + "/" + data[i][1] + "/scatter" );
      ids.push( data[i][0] + "/" + data[i][1] + "/xLine" );
    }
    curveFit
      .layerIds( ids )
      .layerType( function( layerId ) {
        return layerId.split( "/" )[2];
      })
      .select_layers()
        .nelements( function( layerId ) {
          return layerId.split( "/" )[2] == "scatter" ? 10 : 2;
        } )
        .x(function( layerId, k ) {
          return k % 5;
        })
        .y(function( layerId, k ) {
          var drug = layerId.split( "/" )[0],
            cellLine = layerId.split( "/" )[1];
          return Math.floor( k / 5 ) == 0 ? inputData.RTG[drug][cellLine]["D" + ( +k + 1 )] : 
                                          inputData.CTX[drug][cellLine]["D" + ( k - 4 )];
        })
        .symbol( function( layerId, k ) {
          return k > 4 ? "Triangle" : "Wye";
        })
        .lineFun( function( layerId, x, k ) {
          var drug = layerId.split( "/" )[0],
            cellLine = layerId.split( "/" )[1],
            screen;
          k == 0 ? screen = "RTG" : screen = "CTX";
          return get_curve( screen, drug, cellLine, x );
        })
        .dasharray ( function( layerId, k ) {
          return k == 0 ? undefined : 5;
        })
        .colour( function( layerId ) {
          return d3.schemeCategory10[
                    Math.floor( curveFit.layerIds().indexOf( layerId ) % 20 / 2 )
                  ]
        });
    curveFit.update();
    var legIds = [], colours = [];
    for( var i = 0; i < ids.length; i += 2 ){
      legIds.push( ids[i].split( "/" )[0] + "/" + ids[i].split( "/" )[1]);
      colours.push( curveFit.get_layer(ids[i]).get_colour() );
    }
    curveFit.legend.updateScale( [legIds, colours], "drug_and_cell_line" );
  })
  .place( "#heatmap" );
var RTGSlider = lc.colourSlider()
  .set_margins( {left: 100} )
  .title( "RealTime-Glo" )
  .titleX( 45 )
  .titleY( 40 )
  .titleSize( 14 )
  .straightColourScale( 
    d3.scaleLinear()
      .range( [ "black", "rgb(0, 255, 0)" ] )
      .domain( [0, 50] ) 
  )
  .on_change(function(){
    heatmap.updateCellColour();
  })
  .place( "#heatmap" );
var CTXSlider = lc.colourSlider()
  .set_margins( {left: 100} )
  .title( "CellTox" )
  .titleX( 45 )
  .titleY( 40 )
  .titleSize( 14 )
  .straightColourScale(
    d3.scaleLinear()
      .range( [ "black", "rgb(255, 0, 0)" ] )
      .domain( [0, 50] ) 
  )
  .on_change(function(){
    heatmap.updateCellColour();
  })
  .place( "#heatmap" );
heatmap.colour( function( val ){
  return "rgb(" + Math.round( CTXSlider.the_sigmoid( val[1] ) * 255 ) + ", " 
             + Math.round( RTGSlider.the_sigmoid( val[0] ) * 255 ) + ", 0)";
} )
  .updateCellColour();
var curveFit = lc.scatter( "void" )
  .width( 300 )
  .height( 300 )
  .axisTitleX( "Drug concentration" )
  .axisTitleY( "Inhibition" )
  .domainY( [-25, 100] )
  .domainX( [0, 4] )
  .place( "#scatterplot" );
  curveFit.legend.ncol(1)
    .legend.add_block( [["RTG", "CTX"], ["Wye", "Triangle"]], "symbol", "screen" )
    .legend.add_block( [["RTG", "CTX"], [undefined, 5]], "dash", "fit" )
    .legend.add_block( [[], []], "colour", "drug_and_cell_line" );
</script>
	<h3>The code for the example</h3>
	<p>A user of our framework can create apps with very little code. Bellow we show the part of
	the code that hasn&apos;t been explained in previous examples. You can find the complete code
	at the bottom of the page.</p>
	<table><tbody><tr><td valign="top">
		<pre class="example"><x-expl id="skip"></x-expl><code>...</code>
<x-expl id="heatmap"></x-expl><code class="language-javascript">var heatmap = lc.heatmap()</code>
<x-expl id="ids"></x-expl><code class="language-javascript">  .rowIds( drugs )</code>
<x-expl id="ids"></x-expl><code class="language-javascript">  .colIds( cellLines )</code>
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="value"></x-expl><code class="language-javascript">  .value( function( rowId, colId ) {  </code>
<x-expl id="value"></x-expl><code class="language-javascript">    return [inputData.RTG[rowId][colId].avInh, </code>
<x-expl id="value"></x-expl><code class="language-javascript">            inputData.CTX[rowId][colId].avInh];</code>
<x-expl id="value"></x-expl><code class="language-javascript">   })</code>
<x-expl id="inform"></x-expl><code class="language-javascript">  .informText( function( rowId, colId ) {</code>
<x-expl id="inform"></x-expl><code class="language-javascript">      return "Row: &lt;b&gt;" + rowId + "&lt;/b&gt;;&lt;br&gt;" + </code>
<x-expl id="inform"></x-expl><code class="language-javascript">            "Col: &lt;b&gt;" + colId + "&lt;/b&gt;;&lt;br&gt;" + </code>
<x-expl id="inform"></x-expl><code class="language-javascript">            "RTG = " + heatmap.get_value( rowId, colId )[0].toFixed( 2 ) + </code>
<x-expl id="inform"></x-expl><code class="language-javascript">            " ; CTX = " + heatmap.get_value( rowId, colId )[1].toFixed( 2 );</code>
<x-expl id="inform"></x-expl><code class="language-javascript">      })</code>
<x-expl id="on_click"></x-expl><code class="language-javascript">  .on_click( function( rowId, colId ) {</code>
<x-expl id="on_click"></x-expl><code class="language-javascript">    heatmap.mark( d3.select( this ) );</code>
<x-expl id="on_click"></x-expl><code class="language-javascript">  })</code>
<x-expl id="markedUpdated"></x-expl><code class="language-javascript">  .markedUpdated( function(){</code>
<x-expl id="idsArray"></x-expl><code class="language-javascript">    var ids = [],</code>
<x-expl id="get_marked"></x-expl><code class="language-javascript">      data = heatmap.get_marked();</code>
<x-expl id="idsArray"></x-expl><code class="language-javascript">    for(var i = 0; i &lt; data.length; i++) {</code>
<x-expl id="idsArray"></x-expl><code class="language-javascript">      ids.push( data[i][0] + "/" + data[i][1] + "/scatter" );</code>
<x-expl id="idsArray"></x-expl><code class="language-javascript">      ids.push( data[i][0] + "/" + data[i][1] + "/xLine" );</code>
<x-expl id="idsArray"></x-expl><code class="language-javascript">    }</code>
<x-expl id="curveFit"></x-expl><code class="language-javascript">    curveFit</code>
<x-expl id="layerIds"></x-expl><code class="language-javascript">      .layerIds( ids )</code>
<x-expl id="layerType"></x-expl><code class="language-javascript">      .layerType( function( layerId ) {</code>
<x-expl id="layerType"></x-expl><code class="language-javascript">        return layerId.split( "/" )[2];</code>
<x-expl id="layerType"></x-expl><code class="language-javascript">      })</code>
<x-expl id="select_layers"></x-expl><code class="language-javascript">      .select_layers()</code>
<x-expl id="npoints"></x-expl><code class="language-javascript">        .nelements( function( layerId ) {</code>
<x-expl id="npoints"></x-expl><code class="language-javascript">          return layerId.split( "/" )[2] == "scatter" ? 10 : 2;</code>
<x-expl id="npoints"></x-expl><code class="language-javascript">        } )</code>
<x-expl id="xy"></x-expl><code class="language-javascript">        .x(function( layerId, k ) {</code>
<x-expl id="xy"></x-expl><code class="language-javascript">          return k % 5;</code>
<x-expl id="xy"></x-expl><code class="language-javascript">        })</code>
<x-expl id="xy"></x-expl><code class="language-javascript">        .y(function( layerId, k ) {</code>
<x-expl id="xy"></x-expl><code class="language-javascript">          var drug = layerId.split( "/" )[0],</code>
<x-expl id="xy"></x-expl><code class="language-javascript">            cellLine = layerId.split( "/" )[1];</code>
<x-expl id="xy"></x-expl><code class="language-javascript">          return Math.floor( k / 5 ) == 0 ? inputData.RTG[drug][cellLine]["D" + ( +k + 1 )] : </code>
<x-expl id="xy"></x-expl><code class="language-javascript">                                          inputData.CTX[drug][cellLine]["D" + ( k - 4 )];</code>
<x-expl id="xy"></x-expl><code class="language-javascript">        })</code>
<x-expl id="symbol"></x-expl><code class="language-javascript">        .symbol( function( layerId, k ) {</code>
<x-expl id="symbol"></x-expl><code class="language-javascript">          return k &gt; 4 ? "Triangle" : "Wye";</code>
<x-expl id="symbol"></x-expl><code class="language-javascript">        })</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">        .lineFun( function( layerId, x, k ) {</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">          var drug = layerId.split( "/" )[0],</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">            cellLine = layerId.split( "/" )[1],</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">            screen;</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">          k == 0 ? screen = "RTG" : screen = "CTX";</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">          return get_curve( screen, drug, cellLine, x );</code>
<x-expl id="lineFun"></x-expl><code class="language-javascript">        })</code>
<x-expl id="dash"></x-expl><code class="language-javascript">        .dasharray ( function( layerId, k ) {</code>
<x-expl id="dash"></x-expl><code class="language-javascript">          return k == 0 ? undefined : 5;</code>
<x-expl id="dash"></x-expl><code class="language-javascript">        })</code>
<x-expl id="colour"></x-expl><code class="language-javascript">        .colour( function( layerId ) {</code>
<x-expl id="colour"></x-expl><code class="language-javascript">          return d3.schemeCategory10[</code>
<x-expl id="colour"></x-expl><code class="language-javascript">                    Math.floor( curveFit.layerIds().indexOf( layerId ) % 20 / 2 )</code>
<x-expl id="colour"></x-expl><code class="language-javascript">                  ]</code>
<x-expl id="colour"></x-expl><code class="language-javascript">        });</code>
<x-expl id="update"></x-expl><code class="language-javascript">    curveFit.update();</code>
<x-expl id="legendSc"></x-expl><code class="language-javascript">    var legIds = [], colours = [];</code>
<x-expl id="legendSc"></x-expl><code class="language-javascript">    for( var i = 0; i &lt; ids.length; i += 2 ){</code>
<x-expl id="legendSc"></x-expl><code class="language-javascript">      legIds.push( ids[i].split( "/" )[0] + "/" + ids[i].split( "/" )[1]);</code>
<x-expl id="legendSc"></x-expl><code class="language-javascript">      colours.push( curveFit.get_layer(ids[i]).get_colour() );</code>
<x-expl id="legendSc"></x-expl><code class="language-javascript">    }</code>
<x-expl id="legendScUpd"></x-expl><code class="language-javascript">    curveFit.legend.updateScale( [legIds, colours], "drug_and_cell_line" );</code>
<x-expl id="markedUpdated"></x-expl><code class="language-javascript">  })</code>
<x-expl id="heatmap"></x-expl><code class="language-javascript">  .place( "#heatmap" );</code>
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="slider"></x-expl><code class="language-javascript">var RTGSlider = lc.colourSlider()</code>
<x-expl id="margins"></x-expl><code class="language-javascript">  .set_margins( {left: 100} )</code>
<x-expl id="title"></x-expl><code class="language-javascript">  .title( "RealTime-Glo" )</code>
<x-expl id="titlePos"></x-expl><code class="language-javascript">  .titleX( 45 )</code>
<x-expl id="titlePos"></x-expl><code class="language-javascript">  .titleY( 40 )</code>
<x-expl id="titlePos"></x-expl><code class="language-javascript">  .titleSize( 14 )</code>
<x-expl id="straightColorScale"></x-expl><code class="language-javascript">  .straightColourScale( </code>
<x-expl id="straightColorScale"></x-expl><code class="language-javascript">    d3.scaleLinear()</code>
<x-expl id="straightColorScale"></x-expl><code class="language-javascript">      .range( [ "black", "rgb(0, 255, 0)" ] )</code>
<x-expl id="straightColorScale"></x-expl><code class="language-javascript">      .domain( [0, 50] ) </code>
<x-expl id="straightColorScale"></x-expl><code class="language-javascript">  )</code>
<x-expl id="on_change"></x-expl><code class="language-javascript">  .on_change(function(){</code>
<x-expl id="on_change"></x-expl><code class="language-javascript">    heatmap.updateCellColour();</code>
<x-expl id="on_change"></x-expl><code class="language-javascript">  })</code>
<x-expl id="slider"></x-expl><code class="language-javascript">  .place( "#heatmap" );</code>
<x-expl id="slider"></x-expl><code class="language-javascript">var CTXSlider = lc.colourSlider()</code>
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="slider"></x-expl><code class="language-javascript">  .place( "#heatmap" );</code>
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="heatmapColour"></x-expl><code class="language-javascript">heatmap.colour( function( val ){</code>
<x-expl id="heatmapColour"></x-expl><code class="language-javascript">  return "rgb(" + Math.round( CTXSlider.the_sigmoid( val[1] ) * 255 ) + ", " </code>
<x-expl id="heatmapColour"></x-expl><code class="language-javascript">             + Math.round( RTGSlider.the_sigmoid( val[0] ) * 255 ) + ", 0)";</code>
<x-expl id="heatmapColour"></x-expl><code class="language-javascript">} )</code>
<x-expl id="heatmapColour"></x-expl><code class="language-javascript">  .updateCellColour();</code>
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="scatter"></x-expl><code class="language-javascript">var curveFit = lc.scatter( "void" )</code>
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="scatter"></x-expl><code class="language-javascript">  .place( "#scatterplot" );</code>
<x-expl id="legendNcol"></x-expl><code class="language-javascript">  curveFit.legend.ncol(1)</code>
<x-expl id="legendFixed"></x-expl><code class="language-javascript">    .legend.add_block( [["RTG", "CTX"], ["Wye", "Triangle"]], "symbol", "screen" )</code>
<x-expl id="legendFixed"></x-expl><code class="language-javascript">    .legend.add_block( [["RTG", "CTX"], [undefined, 5]], "dash", "fit" )</code>
<x-expl id="legendEmpty"></x-expl><code class="language-javascript">    .legend.add_block( [[], []], "colour", "drug_and_cell_line" );</code>
<x-expl id="skip"></x-expl><code>...</code>
</pre>
	</td>
	<td valign="top" style="padding-left:20px" class="comments">

		<style>
		div.expl {
   		display: none;
   		position: absolute;
   		background: #ddf;
   		padding: 10px;
		}
		</style>

		<p style="background:#f0fff0; padding:10px" id="bubble">
			<i>Click on all the yellow bubbles 
			(<img height="10pt" src="../src/img/bubble_yellow.svg">),
			going from top to bottom, to see explanations of the code.</i>
		</p>
		<br>
	
<div class="expl" id="skip">
<p>Some lines of code, that have been already described in the previous examples, were omitted 
for the sake of simplicity. At the bottom of the page you can find the complete code.</p>
</div>

<div class="expl" id="heatmap">
<p>Here, we initialize and place the heampap. This heatmap will have two values per cell and the resulting colour will be 
influenced by them separately. Another difference from previously described heatmaps will be the reaction to click. Now cells are not clicked,
but rather marked, allowing user to select several cells at once. By default, this behaviour is activated, when
<code>Shift</code> is pressed, but here we are using it as a reaction to a usual click as well.</p>
</div>

<div class="expl" id="ids">
<p>Here, the row IDs are drug names and column IDs are cell lines.</p>
</div>

<div class="expl" id="value">
<p>Here, we have not one, but two values. Both are average inhibitions, but measured by two different assays. 
RTG shows the decrease of number of metabolically active cells compared to the control, while CTX reflects the proportion of dead cells.
In this heatmap we want to show the two values simultaniously and therefore both are passed to the heatmap.</p>
</div>

<div class="expl" id="inform">
<p>By now you probably have already noticed the label that appears each time the cursor hovers onver a cell, point or line.
The <a href="../pages/api.html#heatmap_informText"><code>informText</code></a> property sets the HTML content of this label. The default setting assumes that there is only one 
value for a cell, and can&apos;t properly work with an array of two values. So we redefine it here.</p>
</div>

<div class="expl" id="on_click">
<p>Any chart in the <i>linked-charts</i> library has two modes: clicking and selecting. In clicking mode each click on an element 
triggers <a href="../pages/api.html#layer_on_click"><code>on_click</code></a> function. In selecting mode a click selects or deselects the element. You can switch between the modes in
the instrument <a href="../pages/api.html#panel"><code>panel</code></a>. Also you can keep the <code>Shif</code> button pressed to select an element instead of clicking on it.</p>
<p>Here, we additionally make <a href="../pages/api.html#heatmap_on_click"><code>on_click</code></a> work as selector/deselector, using the <a href="../pages/api.html#heatmap"><code>mark</code></a> method.</p>
</div>

<div class="expl" id="markedUpdated">
<p>The <a href="../pages/api.html#heatmap"><code>markedUpdated</code></a> property is connected with the <a href="../pages/api.html#heatmap"><code>mark</code></a> method. A function, defined here,
is called each time a set of marked points or cells is changed. By default, it&apos;s an empty function. Here, we 
will define a function that updates the layers on the <code>curveFit</code> plot, so that for each selected cell, we get
two layers: one with dots and the other with lines.</p>
</div>

<div class="expl" id="idsArray">
<p>Here, we generate IDs for all the layers we want to have on the curve fit plot. We take all the marked cells IDs
and make a combination of a drug name, a cell line name and a type of the layer we want to have.</p>
</div>

<div class="expl" id="get_marked">
<p><a href="../pages/api.html#heatmap"><code>get_marked</code></a> returns an array of IDs (or pairs of row and column IDs) for all the marked elements
of the chart.</p>
</div>

<div class="expl" id="curveFit">
<p>Here, we define all the dinamic properties of the <code>curveFit</code> chart.</p>
</div>

<div class="expl" id="layerIds">
<p>Here, we define all the layers, providing a set of their IDs. This property works like <a href="../pages/api.html#layer_elementIds"><code>elementIds</code></a>
or <a href="../pages/api.html#heatmap_rowIds"><code>rowIds</code></a>. The layers are added or removed to fit the given array of IDs.</p> 
</div>

<div class="expl" id="layerType">
<p>Here, we define a type of each layer. In most cases it happens automatically, since layers are initialised
by type-specific functions. But here we add layers by updating the set of layer IDs and therefore the type information
is required for proper layer initialisation.</p> 
</div>

<div class="expl" id="select_layers">
<p>The <i>linked-charts</i> library allows the user to manipulate several layers at once. To this end one need
to first select them. The <a href="../pages/api.html#layerChart_select_layers"><code>select_layers</code></a> method takes an array of layer IDs and returns a selection of 
layers. This selection is similar to any chart object with the properties of all the selected layers. The only 
difference is that any property callback function get the layer ID as its first argument.</p>
<p>Here, we select all the existing layers.</p> 
</div>

<div class="expl" id="npoints">
<p>Here, we define the number of elements for each layer depending on its type. A scatter plot will
have ten points, a line chart will contain two lines.</p>
</div>

<div class="expl" id="xy">
<p>Here, we set x and y coordinates for all our scatter layers. Line charts doesn&apos;t have <a href="../pages/api.html#scatter_x"><code>x</code></a> and <a href="../pages/api.html#scatter_y"><code>y</code></a> properties, 
so we don&apos;t need to care about separating layers of two different types from each other. These properties
will be set only for the scatters.</p>
<p>Like in the previous examples, here, on x-axis we have values from 0 to 4 that correspond to one of the tested concentrations.
y-axis shows inhibition values.</p>
</div>

<div class="expl" id="symbol">
<p>Here, we set a symbol for each assay. Inhibition values, measured by RTG will be shown as wyes and by CTX - as triangles.
The <i>linked-charts</i> library can use the symbols supported by
<a href="https://github.com/d3/d3-shape/blob/master/README.md#symbols">d3.symbol()</a> function. They are "Circle", "Cross", 
"Diamond", "Square", "Star", "Triangle", "Wye".</p>
<p>This property is also specific only to the scatters, so will be applied only to this type of layers.</p>
</div>

<div class="expl" id="lineFun">
<p>Here, we define the lines for curve fits almost the same way is has been done in all previous examples. The only difference here is
that we now use both assays and therefore have slightly modified the <code>get_curveFit</code> function so that it, besides a drug
name and a cell line name, will also take an assay name.</p>
</div>

<div class="expl" id="dash">
<p>The <a href="../pages/api.html#line_dasharray"><code>dasharray</code></a> property can make lines dashed. It sets the  
<a href="https://developer.mozilla.org/ru/docs/Web/SVG/Attribute/stroke-dasharray">stroke-dasharray</a> attribute of the lines.
Here, we make the line for RTG solid and for CTX - dashed.</p>
</div>

<div class="expl" id="colour">
<p>Here, we set the colours for both scatter and line charts. Both have the <a href="../pages/api.html#layer_colour"><code>colour</code></a> property, and so we don&apos;t need to
do it separately. We use one of the predefined colour sets, provided by the <a href="https://github.com/d3/d3-scale#schemeCategory10">d3</a>
library.</p>
</div>

<div class="expl" id="legendSc">
<p>To define a legend one need to provide either a scale function that will transform legend elements (colour, size, symbol
etc.) into a label. Another option is an array with two columns: one with elements (colours in this case) and the other with
the corresponding labels. Here, we define such an array. We construct an array of all selected drug-cell line combinations and
an array of all the used colours.</p>
</div>

<div class="expl" id="update">
<p>Here, we update the curveFit plot to display all the changes that were made to the layers.</p>
</div>

<div class="expl" id="legendScUpd">
<p>Instead of updating the entire legend one can just update the scale of a certain block. The <a href="../pages/api.html#legend_updateScale"><code>updateScale</code></a>
function takes a scale (can be a function or a two-dimensional array) and a legend block ID as arguments.</p>
</div>

<div class="expl" id="slider">
<p>A <a href="../pages/api.html#colourSlider"><code>colourSlider</code></a> is another type of basic types of charts implemented in the <i>linked-charts</i> library. 
It&apos;s not a selfsuficient chart, but it can be linked to any continuous colour scale of any of the plots, to allow an easy and 
interactive way of changing the contrast and the midpoint of the scale.</p>
<p>Here, both sliders are defined in almost identical way, so we explain setting only one of them. The full code you can finde
at the bottom of the page.</p>
</div>

<div class="expl" id="straightColorScale">
<p>Here, we define the colour scale that a colour slider will then modify. This scale will take values from 0 to 50 and change
from black to green.</p>
</div>

<div class="expl" id="on_change">
<p>By setting the <a href="../pages/api.html#colourSlider_on_change"><code>on_change</code></a> property the user defines, what should happen if one of the pointers of a colour slider has been 
moved. Here, we would like to have colours of all the cells changed. The most obvious way for that 
to use the <a href="../pages/api.html#chart_update"><code>update</code></a> function. But in this case we know for sure that it&apos;s only the colour that can change. So we 
don&apos;t need all the heatmap elements to be recalculated and rerendered, since with larger charts this may take a considerable amount of 
time. So we use the <a href="../pages/api.html#heatmap_updateCellColour"><code>updateCellColour</code></a> method instead.</p>
</div>

<div class="expl" id="title">
<p>Here, we define a title of the slider.</p>
</div>

<div class="expl" id="margins">
<p>Here, we change the left margin of the slider to make it nicely aligned under the heatmap and leave space for the title.</p>
</div>

<div class="expl" id="titlePos">
<p>Here, we set the position (x and y coordinates) of the title and its size in pixels.</p>
</div>

<div class="expl" id="heatmapColour">
<p>Here, we define colour for each heatmap cell. We can&apos;t just take a transformed <a href="../pages/api.html#colourSlider_colourScale"><code>colourScale</code></a> as it
has been done in the previous example, since our desires colour is a combination of two. So instead from each <a href="../pages/api.html#colourSlider"><code>colourSlider</code></a>
we take the sigmoid transformation of the <a href="../pages/api.html#colourSlider_straightColourScale"><code>straightColourScale</code></a> and use it to get the resulting colour by combining red and 
green channels.</p>
</div>

<div class="expl" id="scatter">
<p>Here, we define an empty plot where the individual inhibition values and fitted curves will be shown. We set only global chart
properties, such as size, axes titles, etc. the same way it has been done previously. You can find the full code at the bottom of
the page.</p>
</div>

<div class="expl" id="legendNcol">
<p>All the blocks of a legend are placed in a rectangle grid. By default, the size of the grid is estimated automatically,
but here we fix the number of columns of the grid to 1.</p>
</div>

<div class="expl" id="legendFixed">
<p>Here, we add to the legend two blocks to show which symbol and which type of line corresponds to which type of assay.</p>
</div>

<div class="expl" id="legendEmpty">
<p>Here, we add an empty block to the legend. This block will be updated after selecting cells of the heatmap.</p>
</div>
</td></tr>
	</tbody></table>

	<div class="fullCode off"><pre><code style="font-size: 16px !important;">Show/hide full code</code></pre></div>
	<div class="fullCode on hidden">
		<pre class="fullCode"><code>Show/hide full code</code>
<code></code>
<code class="language-html">&lt;script src="linked-charts.min.js"&gt;&lt;/script&gt; </code>
<code class="language-html">&lt;link rel="stylesheet" type="text/css" href="linked-charts.css"&gt; </code>
<code class="language-javascript"></code>
<code class="language-html">&lt;script&gt;</code>
<code class="language-javascript">  inputData = [{"CellLine":"Pa16C","Drug":"Galunisertib","minConc":1, ...}, ... ];</code>
<code class="language-html">&lt;/script&gt;</code>
<code class="language-javascript"></code>
<code class="language-html">&lt;table&gt;&lt;tr&gt;</code>
<code class="language-html">  &lt;td id="heatmap" valign="top"&gt;&lt;/td&gt;</code>
<code class="language-html">  &lt;td id="scatterplot" valign="top"&gt;&lt;/td&gt;</code>
<code class="language-html">&lt;/tr&gt;&lt;/table&gt;</code>
<code class="language-javascript"></code>
<code class="language-html">&lt;script&gt;</code>
<code class="language-javascript">inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);</code>
<code class="language-javascript">var drugs = Object.keys(inputData.RTG),</code>
<code class="language-javascript">  cellLines = Object.keys(inputData.RTG[drugs[0]]);</code>
<code class="language-javascript"></code>
<code class="language-javascript">var get_curve = function( screen, drug, cellLine, x ){</code>
<code class="language-javascript">  var max = inputData[screen][drug][cellLine].max,</code>
<code class="language-javascript">    min = inputData[screen][drug][cellLine].min,</code>
<code class="language-javascript">    IC50 = inputData[screen][drug][cellLine].IC50,</code>
<code class="language-javascript">    slope = inputData[screen][drug][cellLine].Slope,</code>
<code class="language-javascript">    minConc = inputData[screen][drug][cellLine].minConc;</code>
<code class="language-javascript"></code>
<code class="language-javascript">  return min + ( max - min )/ </code>
<code class="language-javascript">    (1 + Math.pow( 10, - ( x - Math.log10( IC50/minConc ) ) * slope));</code>
<code class="language-javascript">}</code>
<code class="language-javascript"></code>
<code class="language-javascript">var heatmap = lc.heatmap()</code>
<code class="language-javascript">  .rowIds( drugs )</code>
<code class="language-javascript">  .colIds( cellLines )</code>
<code class="language-javascript">  .title( "Drug effect on viability and cytotoxicity" )</code>
<code class="language-javascript">  .showLegend( false )</code>
<code class="language-javascript">  .margins( {top: 100, left: 100, right: 10, bottom: 10} )</code>
<code class="language-javascript">  .value( function( rowId, colId ) {  </code>
<code class="language-javascript">    return [inputData.RTG[rowId][colId].avInh, </code>
<code class="language-javascript">            inputData.CTX[rowId][colId].avInh];</code>
<code class="language-javascript">   })</code>
<code class="language-javascript">  .informText( function( rowId, colId ) {</code>
<code class="language-javascript">      return "Row: &lt;b&gt;" + rowId + "&lt;/b&gt;;&lt;br&gt;" + </code>
<code class="language-javascript">            "Col: &lt;b&gt;" + colId + "&lt;/b&gt;;&lt;br&gt;" + </code>
<code class="language-javascript">            "RTG = " + heatmap.get_value( rowId, colId )[0].toFixed( 2 ) + </code>
<code class="language-javascript">            " ; CTX = " + heatmap.get_value( rowId, colId )[1].toFixed( 2 );</code>
<code class="language-javascript">      })</code>
<code class="language-javascript">  .on_click( function( rowId, colId ) {</code>
<code class="language-javascript">    heatmap.mark( d3.select( this ) );</code>
<code class="language-javascript">  })</code>
<code class="language-javascript">  .markedUpdated( function(){</code>
<code class="language-javascript">    var ids = [],</code>
<code class="language-javascript">      data = heatmap.get_marked();</code>
<code class="language-javascript">    for(var i = 0; i &lt; data.length; i++) {</code>
<code class="language-javascript">      ids.push( data[i][0] + "/" + data[i][1] + "/scatter" );</code>
<code class="language-javascript">      ids.push( data[i][0] + "/" + data[i][1] + "/xLine" );</code>
<code class="language-javascript">    }</code>
<code class="language-javascript">    curveFit</code>
<code class="language-javascript">      .layerIds( ids )</code>
<code class="language-javascript">      .layerType( function( layerId ) {</code>
<code class="language-javascript">        return layerId.split( "/" )[2];</code>
<code class="language-javascript">      })</code>
<code class="language-javascript">      .select_layers()</code>
<code class="language-javascript">        .nelements( function( layerId ) {</code>
<code class="language-javascript">          return layerId.split( "/" )[2] == "scatter" ? 10 : 2;</code>
<code class="language-javascript">        } )</code>
<code class="language-javascript">        .x(function( layerId, k ) {</code>
<code class="language-javascript">          return k % 5;</code>
<code class="language-javascript">        })</code>
<code class="language-javascript">        .y(function( layerId, k ) {</code>
<code class="language-javascript">          var drug = layerId.split( "/" )[0],</code>
<code class="language-javascript">            cellLine = layerId.split( "/" )[1];</code>
<code class="language-javascript">          return Math.floor( k / 5 ) == 0 ? inputData.RTG[drug][cellLine]["D" + ( +k + 1 )] : </code>
<code class="language-javascript">                                          inputData.CTX[drug][cellLine]["D" + ( k - 4 )];</code>
<code class="language-javascript">        })</code>
<code class="language-javascript">        .symbol( function( layerId, k ) {</code>
<code class="language-javascript">          return k &gt; 4 ? "Triangle" : "Wye";</code>
<code class="language-javascript">        })</code>
<code class="language-javascript">        .lineFun( function( layerId, x, k ) {</code>
<code class="language-javascript">          var drug = layerId.split( "/" )[0],</code>
<code class="language-javascript">            cellLine = layerId.split( "/" )[1],</code>
<code class="language-javascript">            screen;</code>
<code class="language-javascript">          k == 0 ? screen = "RTG" : screen = "CTX";</code>
<code class="language-javascript">          return get_curve( screen, drug, cellLine, x );</code>
<code class="language-javascript">        })</code>
<code class="language-javascript">        .dasharray ( function( layerId, k ) {</code>
<code class="language-javascript">          return k == 0 ? undefined : 5;</code>
<code class="language-javascript">        })</code>
<code class="language-javascript">        .colour( function( layerId ) {</code>
<code class="language-javascript">          return d3.schemeCategory10[</code>
<code class="language-javascript">                    Math.floor( curveFit.layerIds().indexOf( layerId ) % 20 / 2 )</code>
<code class="language-javascript">                  ]</code>
<code class="language-javascript">        });</code>
<code class="language-javascript">    curveFit.update();</code>
<code class="language-javascript">    var legIds = [], colours = [];</code>
<code class="language-javascript">    for( var i = 0; i &lt; ids.length; i += 2 ){</code>
<code class="language-javascript">      legIds.push( ids[i].split( "/" )[0] + "/" + ids[i].split( "/" )[1]);</code>
<code class="language-javascript">      colours.push( curveFit.get_layer(ids[i]).get_colour() );</code>
<code class="language-javascript">    }</code>
<code class="language-javascript">    curveFit.legend.updateScale( [legIds, colours], "drug_and_cell_line" );</code>
<code class="language-javascript">  })</code>
<code class="language-javascript">  .place( "#heatmap" );</code>
<code class="language-javascript"></code>
<code class="language-javascript">var RTGSlider = lc.colourSlider()</code>
<code class="language-javascript">  .set_margins( {left: 100} )</code>
<code class="language-javascript">  .title( "RealTime-Glo" )</code>
<code class="language-javascript">  .titleX( 45 )</code>
<code class="language-javascript">  .titleY( 40 )</code>
<code class="language-javascript">  .titleSize( 14 )</code>
<code class="language-javascript">  .straightColourScale( </code>
<code class="language-javascript">    d3.scaleLinear()</code>
<code class="language-javascript">      .range( [ "black", "rgb(0, 255, 0)" ] )</code>
<code class="language-javascript">      .domain( [0, 50] ) </code>
<code class="language-javascript">  )</code>
<code class="language-javascript">  .on_change(function(){</code>
<code class="language-javascript">    heatmap.updateCellColour();</code>
<code class="language-javascript">  })</code>
<code class="language-javascript">  .place( "#heatmap" );</code>
<code class="language-javascript">var CTXSlider = lc.colourSlider()</code>
<code class="language-javascript">  .set_margins( {left: 100} )</code>
<code class="language-javascript">  .title( "CellTox" )</code>
<code class="language-javascript">  .titleX( 45 )</code>
<code class="language-javascript">  .titleY( 40 )</code>
<code class="language-javascript">  .titleSize( 14 )</code>
<code class="language-javascript">  .straightColourScale(</code>
<code class="language-javascript">    d3.scaleLinear()</code>
<code class="language-javascript">      .range( [ "black", "rgb(255, 0, 0)" ] )</code>
<code class="language-javascript">      .domain( [0, 50] ) </code>
<code class="language-javascript">  )</code>
<code class="language-javascript">  .on_change(function(){</code>
<code class="language-javascript">    heatmap.updateCellColour();</code>
<code class="language-javascript">  })</code>
<code class="language-javascript">  .place( "#heatmap" );</code>
<code class="language-javascript"></code>
<code class="language-javascript">heatmap.colour( function( val ){</code>
<code class="language-javascript">  return "rgb(" + Math.round( CTXSlider.the_sigmoid( val[1] ) * 255 ) + ", " </code>
<code class="language-javascript">             + Math.round( RTGSlider.the_sigmoid( val[0] ) * 255 ) + ", 0)";</code>
<code class="language-javascript">} )</code>
<code class="language-javascript">  .updateCellColour();</code>
<code class="language-javascript"></code>
<code class="language-javascript">var curveFit = lc.scatter( "void" )</code>
<code class="language-javascript">  .width( 300 )</code>
<code class="language-javascript">  .height( 300 )</code>
<code class="language-javascript">  .axisTitleX( "Drug concentration" )</code>
<code class="language-javascript">  .axisTitleY( "Inhibition" )</code>
<code class="language-javascript">  .domainY( [-25, 100] )</code>
<code class="language-javascript">  .domainX( [0, 4] )</code>
<code class="language-javascript">  .place( "#scatterplot" );</code>
<code class="language-javascript">  curveFit.legend.ncol(1)</code>
<code class="language-javascript">    .legend.add_block( [["RTG", "CTX"], ["Wye", "Triangle"]], "symbol", "screen" )</code>
<code class="language-javascript">    .legend.add_block( [["RTG", "CTX"], [undefined, 5]], "dash", "fit" )</code>
<code class="language-javascript">    .legend.add_block( [[], []], "colour", "drug_and_cell_line" );</code>
<code class="language-html">&lt;/script&gt;</code>
</pre>
	</div>

	<script>
	d3.select("head")
		.select("title")
			.text(d3.select(".description")
							.select("h1").text());

	d3.selectAll( "x-expl" )
	  .append( "img" )
	    .attr( "height", "10pt" )
	    .attr( "class", "bubble_icon" )
	    .attr( "src", "../src/img/bubble_yellow.svg" )
	    .style( "padding-right", "15px")
	    .on( "click", function() {
	      d3.selectAll( "div.expl" )
	        .style( "display", "none" );
	      d3.selectAll( "img.bubble_icon" )
	        .attr( "src", "../src/img/bubble_yellow.svg")
	      var tagId = d3.select(this.parentNode).attr("id");
	      d3.select( "div.expl#" + tagId )
	        .style( "display", "block" )
	        .style("width", d3.select("#bubble").node().getBoundingClientRect().width)
	      d3.selectAll( "x-expl#" + tagId ).select("img.bubble_icon")
	        .attr( "src", "../src/img/bubble_red.svg")
	    });

	d3.select("div.fullCode.off")
		.on("click", function() {
			d3.select(this).classed("hidden", true);
			d3.select("div.fullCode.on").classed("hidden", false);
		});
	d3.select("div.fullCode.on")
		.on("click", function() {
			d3.select(this).classed("hidden", true);
			d3.select("div.fullCode.off").classed("hidden", false);
		})

	</script>

</div>

</body></html>